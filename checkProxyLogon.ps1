#
# This Script checks for sign of exploit from CVE-2021-26855, 26858, 26857, and 27065
#

# get the exchange installation path
function Get-ExchangeInstallPath {
    return (Get-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\ExchangeServer\v15\Setup -ErrorAction SilentlyContinue).MsiInstallPath
}

# build new logfile name with date and cve number
function New-Logname($cve) {
    return (Get-Date).ToString("MM-dd-yyyy-hh-mm-ss") + "-" + $cve + ".log"
}

function Write-Log($response) {
    $logname = New-Logname($response[2])
    $response[1].Hits | Export-Csv -Path $PSScriptRoot/$logname
}

function Get-Cve26855 {

    # status: true = CRITICAL // false = OK
    $status = $false

    $exchangePath = Get-ExchangeInstallPath

    # append proxy path to exchange path
    $HttpProxyPath = Join-Path -Path $exchangePath -ChildPath "Logging/HttpProxy"
    
    # needed props
    $outProps = @(
        "DateTime", "RequestId", "ClientIPAddress", "UrlHost",
        "UrlStem", "RoutingHint", "UserAgent", "AnchorMailbox",
        "HttpStatus"
    )

    # get all log files
    $files = (Get-ChildItem -Recurse -Path $HttpProxyPath -Filter "*.log").FullName

    $allResults = @{
        Hits     = [System.Collections.ArrayList]@()
        FileList = [System.Collections.ArrayList]@()
    }

    For ($i = 1; $i -lt $files.Count; $i++) {

        if ((Test-Path $files[$i]) -and (Select-String -Path $files[$i] -Pattern "ServerInfo~" -Quiet)) {
            $status = $true
            [Void]$allResults.FileList.Add($files[$i])
            Import-Csv -Path $files[$i] -ErrorAction SilentlyContinue |
            Where-Object { $_.AuthenticatedUser -eq "" -and $_.AnchorMailbox -Like "ServerInfo~*/*" } |
                Select-Object -Property $outProps |
                ForEach-Object {
                    [Void]$allResults.Hits.Add($_)
                }
        }
    }

    return @(
        $status,
        $allResults,
        $cve = 26855
    )
}

$check = Get-Cve26855

if ($check[0]) {
    Write-Log($check)
}